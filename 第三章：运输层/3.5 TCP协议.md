# 3.5 TCP 协议

## 3.5.1 TCP 连接

TCP 依赖 差错检测, 重传, 累计确认, 定时器以及用于序号和确认号的首部字段

TCP 是面向连接的, 连接的双方都将初始化与TCP连接相关的许多TCP状态变量

TCP 连接总是点对点的, TCP建立连接的过程被称为三次握手, 三次握手的过程如下:

1. 客户发送一个特殊的TCP报文段
2. 服务器响应客户的报文段, 并发送一个特殊的TCP报文段
3. 客户响应服务器的报文段(可以承担有效载荷, 即应用层的数据)

过程:

进程写数据 ---> 套接字 ---> TCP发送缓存 ---> 网络 ---> TCP接收缓存 ---> 套接字 ---> 进程读数据

## 3.5.2 TCP 报文段结构

```
源端口号 | 目的端口号
序号
确认号
首部长度 | 保留位 | 标志位 | 接收窗口
因特网检验和 | 紧急数据指针
选项
数据
```

- 接收窗口字段: 用于流量控制
- 可选与变长的选项字段: 发送方与接收方协商最大报文段长度, 窗口缩放因子, 时间戳等
- 标志字段:
  - URG: 紧急指针字段有效
  - ACK: 确认号字段有效
  - PSH: 接收方应尽快将数据交付给应用层
  - RST: 重置连接
  - SYN: 同步序号, 用于建立连接
  - FIN: 发送方完成发送数据

  TCP 把数据看成 一个无结构的、有序的字节流, 发送方会隐式的对每一个字节编号, 对于每个报文段, 序号字段是首字节的序号

  确认号是主机希望下一个接收的TCP报文段的序号

## 3.5.3 往返时间的估计与超时

### 估计往返时间

RTT: 发送方把报文段给IP层开始, 到发送方收到确认的时间间隔

仅为传输一次的报文段测量, 不包括重传的时间

并且采用取平均的办法, 以减少由于网络延迟的变化而导致的错误估计

### 设置和管理重传超时间隔

超时间隔 为估计的RTT 加上一个安全 margin, 在一次超时后timeoutInterval 加倍

## 3.5.4 可靠数据传输

TCP 有三个与发送和重传有关的主要事件(书p157):

1. 从上层应用程序接收数据
2. 定时器超时
3. 收到ACK

## 3.5.5 流量控制

如果接收方的tcp缓存已满, 为了防止缓存溢出, TCP提供了流量控制服务, 它是一个速度匹配服务, 简单来说让读取速率与接收速率相匹配

它与拥塞控制服务不同, 拥塞控制服务是为了防止网络拥塞, 而流量控制服务是为了防止接收方缓存溢出

如何实现流量控制:

用缓存区的第一个字节的序号作为流量控制的基础, 用最后一个字节的序号减去第一个字节的序号, 再用总的缓存区大小减去这个值, 就得到了接收窗口的大小, 接收方发送窗口大小给发送方, 只要这个窗口大小大于0, 发送方就可以发送数据, 若等于0, 发送方会持续发送大小为1字节的数据, 接收方会清空缓存区

## 3.5.6 TCP连接管理

TCP 连接管理是指 TCP 连接的建立和断开过程, 它是 TCP 协议的一个重要组成部分

TCP 连接管理的过程如下:

1. 客户端的TCP首先向服务器的TCP发送一个特殊的TCP报文段, 随机选择一个初始序号 标志位SYN比特置为1, SYN报文段
2. 当数据报到达服务器时, 服务器提取SYN报文段, 为该TCP连接分配TCP缓存和变量, 并向客户发送允许连接的报文段, SYN被置为1, 并选择自己的初始序号, SYNACK报文段
3. 客户在收到SYNACK报文段后, 为该TCP连接分配TCP缓存和变量, 并为服务器发送确认, 其中SYN置为0, 可以携带应用层数据

连接断开的过程如下:

1. 客户或服务器中的应用进程首先发送一个FIN报文段, 标志位FIN置为1, 表示客户或服务器完成发送数据
2. 接收方收到FIN报文段后, 发送一个确认报文段, 标志位ACK置为1, 确认号为收到的FIN报文段的序号加1
3. 接收方在发送完所有数据后, 也发送一个FIN报文段, 标志位FIN置为1, 表示完成发送数据
4. 发送方收到FIN报文段后, 发送一个确认报文段, 标志位ACK置为1, 确认号为收到的FIN报文段的序号加1
5. 连接断开


